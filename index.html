import React, { useState } from 'react';
import ImageUploader from './components/ImageUploader';
import SongCard from './components/SongCard';
import HistoryList from './components/HistoryList';
import { analyzeImageAndSuggestSong } from './services/geminiService';
import { SongRecommendation, HistoryItem } from './types';
import { Sparkles, Zap, TrendingUp, Sparkles as SparklesIcon, AlignLeft, Music, Info, X } from 'lucide-react';

const VIBE_OPTIONS = [
  "Surprise Me",
  "Arabic",
  "Iraqi",
  "English Pop",
  "Khaleeji",
  "Hip Hop/Rap",
  "Indie/Alt",
  "K-Pop",
  "Techno/House",
  "Classical"
];

const App: React.FC = () => {
  const [currentImage, setCurrentImage] = useState<string | null>(null);
  const [recommendations, setRecommendations] = useState<SongRecommendation[]>([]);
  const [activeIndex, setActiveIndex] = useState(0);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [history, setHistory] = useState<HistoryItem[]>([]);
  const [musicPreference, setMusicPreference] = useState<string>("Surprise Me");
  const [showInfo, setShowInfo] = useState(false);

  const handleImageSelected = async (base64: string, mimeType: string) => {
    setCurrentImage(base64);
    setRecommendations([]);
    setError(null);
    setIsLoading(true);
    setActiveIndex(0);

    try {
      const results = await analyzeImageAndSuggestSong(base64, mimeType, musicPreference);
      
      const newHistoryItem: HistoryItem = {
        id: Date.now().toString(),
        imageUrl: base64,
        recommendations: results,
        timestamp: Date.now()
      };

      setRecommendations(results);
      setHistory(prev => [newHistoryItem, ...prev].slice(0, 9)); // Keep last 9
    } catch (err) {
      console.error(err);
      setError("We couldn't catch the vibe. The AI might be having a creative block or the image format isn't supported. Please try again.");
    } finally {
      setIsLoading(false);
    }
  };

  const handleHistorySelect = (item: HistoryItem) => {
    setCurrentImage(item.imageUrl);
    setRecommendations(item.recommendations);
    setActiveIndex(0);
    setError(null);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const handleReset = () => {
    setCurrentImage(null);
    setRecommendations([]);
    setError(null);
    setActiveIndex(0);
  };

  const getIconForCategory = (category: string) => {
    if (category.toLowerCase().includes('trending') || category.toLowerCase().includes('main')) return <TrendingUp className="w-4 h-4" />;
    if (category.toLowerCase().includes('aesthetic')) return <SparklesIcon className="w-4 h-4" />;
    return <AlignLeft className="w-4 h-4" />;
  };

  return (
    <div className="min-h-screen bg-[#0f172a] text-slate-200 selection:bg-indigo-500/30 selection:text-indigo-200 pb-20 overflow-x-hidden relative">
      
      {/* Background decoration */}
      <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div className="absolute top-0 left-1/4 w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[120px] mix-blend-screen animate-[pulse_8s_ease-in-out_infinite]"></div>
        <div className="absolute bottom-0 right-1/4 w-[500px] h-[500px] bg-purple-600/10 rounded-full blur-[120px] mix-blend-screen animate-[pulse_10s_ease-in-out_infinite_reverse]"></div>
      </div>

      <div className="relative z-10 max-w-6xl mx-auto px-4 md:px-6">
        
        {/* Header */}
        <header className="py-8 md:py-12 flex flex-col items-center justify-center text-center">
          <div className="inline-flex items-center gap-2 mb-4 px-3 py-1 rounded-full bg-slate-800/50 border border-slate-700 backdrop-blur-sm">
             <Sparkles className="w-4 h-4 text-amber-300" />
             <span className="text-xs font-medium text-slate-300">Powered by DeeVoo 2.5</span>
          </div>
          
          <h1 
            className="font-display text-5xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-200 via-white to-purple-200 mb-4 cursor-pointer"
            onClick={handleReset}
          >
            VibeTune
          </h1>
          <p className="text-lg text-slate-400 max-w-md mx-auto leading-relaxed">
            Upload a photo for your <span className="text-pink-400 font-medium">Vibe story</span>. We'll find 3 perfect tracks to match the aesthetic.
          </p>

          <button
            onClick={() => setShowInfo(true)}
            className="mt-4 flex items-center gap-2 text-slate-500 hover:text-indigo-300 transition-colors text-sm"
          >
            <Info className="w-4 h-4" />
            <span>How does it work?</span>
          </button>
        </header>

        {/* Main Content Area */}
        <main className="flex flex-col items-center min-h-[400px]">
          
          {/* Vibe Selector & Uploader */}
          {recommendations.length === 0 && !isLoading && (
            <div className="w-full animate-[fadeIn_0.5s_ease-out]">
              
              {/* Vibe Selector Pills */}
              <div className="max-w-xl mx-auto mb-6">
                 <div className="flex items-center gap-2 mb-3 text-slate-400 text-sm font-medium px-2">
                    <Music className="w-4 h-4" />
                    <span>Choose your vibe</span>
                 </div>
                 <div className="flex flex-wrap gap-2 justify-center md:justify-start">
                   {VIBE_OPTIONS.map((vibe) => (
                     <button
                       key={vibe}
                       onClick={() => setMusicPreference(vibe)}
                       className={`
                         px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border
                         ${musicPreference === vibe 
                           ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/25 scale-105' 
                           : 'bg-slate-800/40 text-slate-400 border-slate-700/50 hover:bg-slate-800 hover:border-slate-600 hover:text-slate-200'
                         }
                       `}
                     >
                       {vibe}
                     </button>
                   ))}
                 </div>
              </div>

               <ImageUploader onImageSelected={handleImageSelected} isLoading={isLoading} />
            </div>
          )}

          {/* Loading State */}
          {isLoading && (
             <div className="w-full max-w-xl mx-auto flex flex-col items-center justify-center min-h-[300px]">
                <div className="relative">
                   <div className="absolute inset-0 bg-indigo-500/20 blur-xl rounded-full animate-pulse"></div>
                   <img 
                      src={currentImage || ''} 
                      alt="Analyzing" 
                      className="w-32 h-32 rounded-full object-cover relative z-10 border-4 border-indigo-500/30 animate-[spin_3s_linear_infinite]"
                   />
                </div>
                <h3 className="mt-8 text-2xl font-display font-bold text-white">Curating Vibes...</h3>
                <p className="mt-2 text-slate-400">Selecting {musicPreference !== "Surprise Me" ? musicPreference : "perfect"} tracks for your story</p>
             </div>
          )}

          {/* Error State */}
          {error && (
            <div className="w-full max-w-md bg-red-500/10 border border-red-500/20 rounded-xl p-6 text-center mt-8">
               <div className="w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-red-400">
                 <Zap className="w-6 h-6" />
               </div>
               <p className="text-red-200">{error}</p>
               <button 
                 onClick={handleReset}
                 className="mt-4 px-6 py-2 bg-red-600/20 hover:bg-red-600/30 text-red-200 rounded-lg transition-colors text-sm font-medium"
               >
                 Try Again
               </button>
            </div>
          )}

          {/* Result */}
          {recommendations.length > 0 && currentImage && !isLoading && (
            <div className="w-full flex flex-col items-center">
              
              {/* Option Selectors */}
              <div className="w-full max-w-4xl mx-auto mb-6 flex flex-wrap justify-center gap-3">
                {recommendations.map((rec, index) => (
                  <button
                    key={index}
                    onClick={() => setActiveIndex(index)}
                    className={`
                      flex items-center gap-2 px-5 py-2.5 rounded-full text-sm font-medium transition-all duration-300 border
                      ${activeIndex === index 
                        ? 'bg-indigo-500 text-white border-indigo-400 shadow-[0_0_20px_rgba(99,102,241,0.5)] transform scale-105' 
                        : 'bg-slate-800/50 text-slate-400 border-slate-700 hover:bg-slate-800 hover:text-slate-200'
                      }
                    `}
                  >
                    {getIconForCategory(rec.category)}
                    {rec.category}
                  </button>
                ))}
              </div>

              {/* Display Active Card */}
              <div className="w-full relative">
                {recommendations.map((rec, index) => (
                   <div 
                    key={index} 
                    className={index === activeIndex ? 'block' : 'hidden'}
                   >
                     <SongCard data={rec} imageUrl={currentImage} />
                   </div>
                ))}
              </div>
              
              <button 
                onClick={handleReset}
                className="mt-12 px-8 py-3 rounded-full bg-slate-800 hover:bg-slate-700 text-slate-300 border border-slate-600 transition-all hover:scale-105"
              >
                Scan Another Vibe
              </button>
            </div>
          )}

        </main>

        {/* History Section */}
        <HistoryList items={history} onSelect={handleHistorySelect} />

      </div>

      {/* Info Modal */}
      {showInfo && (
        <div 
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]"
          onClick={() => setShowInfo(false)}
        >
          <div 
            className="bg-slate-900 border border-slate-700 p-6 md:p-8 rounded-3xl max-w-md w-full shadow-2xl relative animate-[scaleIn_0.3s_ease-out]" 
            onClick={e => e.stopPropagation()}
          >
            <button 
              onClick={() => setShowInfo(false)} 
              className="absolute top-4 right-4 p-2 text-slate-500 hover:text-white hover:bg-slate-800 rounded-full transition-colors"
            >
              <X className="w-5 h-5" />
            </button>
            
            <h3 className="text-xl font-display font-bold text-white mb-6 flex items-center gap-3">
              <div className="p-2 bg-indigo-500/20 rounded-lg">
                <Sparkles className="w-5 h-5 text-indigo-400" />
              </div>
              The Science of Vibe
            </h3>
            
            <div className="space-y-6 text-slate-300 leading-relaxed">
                <p>
                  VibeTune isn't just random. It uses <strong>Google's Gemini 2.5 Flash</strong>—a cutting-edge multimodal AI model—to experience your photo with "machine synesthesia."
                </p>

                <div className="space-y-4">
                  <p className="text-sm font-semibold text-slate-400 uppercase tracking-wider">How it decodes the mood:</p>
                  
                  <div className="grid gap-3">
                    <div className="bg-slate-800/40 p-3 rounded-lg border border-slate-700/50">
                        <h4 className="text-white font-medium text-sm mb-1 flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-indigo-400"></div>
                            Visual Semantics
                        </h4>
                        <p className="text-xs text-slate-400">It identifies objects, scenery (beach vs. bedroom), and cultural markers in the frame.</p>
                    </div>
                    
                    <div className="bg-slate-800/40 p-3 rounded-lg border border-slate-700/50">
                         <h4 className="text-white font-medium text-sm mb-1 flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-pink-400"></div>
                            Atmospheric Extraction
                        </h4>
                        <p className="text-xs text-slate-400">It analyzes lighting temperature, color saturation, and shadow depth to determine emotional weight.</p>
                    </div>

                     <div className="bg-slate-800/40 p-3 rounded-lg border border-slate-700/50">
                         <h4 className="text-white font-medium text-sm mb-1 flex items-center gap-2">
                            <div className="w-2 h-2 rounded-full bg-emerald-400"></div>
                            Sonic Mapping
                        </h4>
                        <p className="text-xs text-slate-400">Finally, it cross-references this data with vast musical knowledge to match genre, tempo, and lyrical themes to your visual moment.</p>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
